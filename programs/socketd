function socketDaemon()
	--true if daemon found in socketTable, false to return event.
	local returnStatus = true
	while true do
		local inSocket, id, msg, dist = coroutine.yield(returnStatus)
		returnStatus = false
		local routeNum
		for rNum,rInfo in ipairs(net.routeTable) do
			if id == rInfo.idNum then
				routeNum = rNum
			end
		end
		if net.socketTable[inSocket] then
			returnStatus = true
			coroutine.resume(net.daemonTable[net.socketTable[inSocket]], routeNum, string.match(msg, "^(%a%a):(%d+,%d+;.*)"), dist)
			if coroutine.status(net.daemonTable[net.socketTable[inSocket]]) == "dead" then
				net.daemonTable[net.socketTable[inSocket]] = nil
				net.socketTable[inSocket] = nil
			end
		end
end

local sockd = coroutine.create(socketDaemon)
coroutine.resume(sockd)

local oldpull = os.pullEvent

function newPull(filter)
	while true do
		local event = {oldpull(filter)}
		if event[1] == "socket_message" then
			result = {coroutine.resume(sockd, event[2], event[3], event[4], event[5])}
			if not result[2] then
				return unpack(event)
			end
		else
			return unpack(event)
		end
	end
end

rawset(os, "pullEvent", newPull)